<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bedwars Sweat Tracker</title>
<style>
  
/* Reset and dark background */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #0d1117;
  color: #e5e5e5;
  margin: 20px;
  line-height: 1.4;
}

/* Headings */
h1 {
  text-align: center;
  margin-bottom: 30px;
  color: #00c8ff; /* cyan blue */
  font-weight: 700;
  letter-spacing: 1px;
  text-shadow: 0 0 12px rgba(0, 200, 255, 0.65);
}

.section-header {
  text-align: center;
  color: #00c8ff;
  font-weight: 600;
  margin: 20px 0 10px;
  font-size: 1.4em;
  text-shadow: 0 0 6px rgba(0, 200, 255, 0.4);
}


/* Form Container */
#form-container {
  max-width: 680px;
  margin: 0 auto 40px;
  background: #161b22;
  padding: 20px 25px;
  border-radius: 12px;
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

form > div {
  margin-bottom: 15px;
}

/* Input Fields */
input[type="text"] {
  flex: 1;
  padding: 10px 15px;
  border: 2px solid #2d333b;
  border-radius: 6px;
  font-size: 16px;
  background: #1c2128;
  color: #e5e5e5;
  transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
}

input[type="text"]::placeholder {
  color: #7a8490;
}

input[type="text"]:focus {
  outline: none;
  border-color: #00c8ff;
  box-shadow: 0 0 10px rgba(0, 200, 255, 0.6);
  background: #20262f;
}

/* Buttons */
button {
  background: linear-gradient(135deg, #00c8ff, #0072ff);
  border: none;
  color: #fff;
  padding: 10px 18px;
  font-size: 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.3s;
  font-weight: 700;
}

button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 14px rgba(0, 200, 255, 0.6);
}

/* Checkbox Labels */
.checkbox-group label {
  margin-right: 20px;
  font-weight: 600;
  user-select: none;
  cursor: pointer;
  color: #cfd6dd;
}

/* Status Message */
#status {
  margin-top: 10px;
  min-height: 22px;
  color: #00c8ff;
  font-weight: 600;
}

/* Stats Display */
#statsDisplay {
  display: none;
  max-width: 880px;
  margin: 0 auto 40px;
  background: #161b22;
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.85);
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
  color: #e5e5e5;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

#statsContent {
  display: flex;
  gap: 15px;
  width: 100%;
  align-items: center;
}

#statsAvatar {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  border: 3px solid #00c8ff;
  flex-shrink: 0;
  background: #20262f;
}

/* Stats Right Section */
#statsRight {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#statsTopRow {
  display: flex;
  gap: 10px;
  align-items: center;
  font-weight: 700;
  font-size: 1.3em;
  color: #00c8ff;
  text-shadow: 0 0 6px rgba(0, 200, 255, 0.5);
}

#statsRank {
  padding: 2px 8px;
  border-radius: 6px;
  background: linear-gradient(135deg, #00c8ff, #0072ff);
  color: #fff;
  min-width: 70px;
  text-align: center;
  font-size: 0.9em;
}

#statsStar {
  color: #0099ff; /* sleek blue star */
  font-size: 1.4em;
}

/* Stat Columns */
#statsColumns {
  display: flex;
  gap: 30px;
  justify-content: space-between;
  flex-wrap: wrap;
}

.stat-column {
  flex: 1;
  min-width: 140px;
}

.stat-label {
  font-size: 0.85em;
  color: #4dabf7; /* soft blue accent */
  margin-top: 6px;
  font-weight: 600;
}

.stat-value {
  font-size: 1.1em;
  font-weight: 700;
  color: #e5e5e5;
}

.stat-column.good .stat-value {
  color: #00e676;
  text-shadow: 0 0 6px rgba(0, 230, 118, 0.6);
}

.stat-column.bad .stat-value {
  color: #ff4c4c;
  text-shadow: 0 0 6px rgba(255, 76, 76, 0.6);
}

.stat-column.neutral .stat-value {
  color: #00bfff;
  text-shadow: 0 0 6px rgba(0, 191, 255, 0.6);
}

/* Search Box */
#searchContainer {
  max-width: 1080px;
  margin: 0 auto 20px;
  display: flex;
  justify-content: center;
}

#searchInput {
  width: 100%;
  max-width: 400px;
  padding: 8px 12px;
  font-size: 16px;
  border: 2px solid #2d333b;
  border-radius: 6px;
  background: #1c2128;
  color: #e5e5e5;
  transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
}

#searchInput::placeholder {
  color: #7a8490;
}

#searchInput:focus {
  outline: none;
  border-color: #00c8ff;
  box-shadow: 0 0 10px rgba(0, 200, 255, 0.6);
  background: #20262f;
}

/* Filter Bar */
.filter-bar {
  max-width: 1080px;
  margin: 0 auto 18px;
  display: flex;
  gap: 12px;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
}

.filter-bar label {
  font-weight: 600;
  color: #cfd6dd;
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-bar input[type="number"],
.filter-bar input[type="date"] {
  width: 100px;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1.5px solid #2d333b;
  background: #1c2128;
  color: #e0e0e0;
}

#minStars, #minFkdr, #minIndex {
  width: 65px; /* adjust this value as needed */
}

#minDate {
  width: 110px; /* adjust this value as needed */
}

/* Remove spinner arrows in Chrome, Edge, Safari */
#minStars::-webkit-outer-spin-button,
#minStars::-webkit-inner-spin-button,
#minFkdr::-webkit-outer-spin-button,
#minFkdr::-webkit-inner-spin-button,
#minIndex::-webkit-outer-spin-button,
#minIndex::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Remove spinner arrows in Firefox */
#minStars, #minFkdr, #minIndex {
  -moz-appearance: textfield;
}

/* Table */
table {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto 40px;
  border-collapse: collapse;
  background: #161b22;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgb(0 0 0 / 0.7);
  color: #e0e0e0;
}

thead tr {
  background: linear-gradient(135deg, #00c8ff, #0072ff);
  color: #fff;
  font-weight: 700;
  user-select: none;
}

th, td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #2d333b;
  vertical-align: middle;
}

tbody tr:hover {
  background: #1f2a35;
}

th.sortable {
  cursor: pointer;
}

th.sortable:hover {
  background: #22303c;
}

/* Added avatar in table row */
.user-cell {
  display: flex;
  align-items: center;
  gap: 12px;
  line-height: 1;
}

.user-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 1.5px solid #00c8ff;
  flex-shrink: 0;
}

td.user-cell {
  vertical-align: middle;
  padding: 12px 15px;
}


</style>
</head>
<body>

<h1>Bedwars Sweat Tracker</h1>
<div id="credits" style="text-align:center; color:#7a8490; margin-bottom:25px; font-size:0.9em;">
  Developed by Milo and ChatGPT
</div>

<h2 class="section-header">Sweat Lookup</h2>
<div id="form-container">
  <form id="sweatForm" autocomplete="off">
    <div style="display:flex; gap:10px; align-items:center;">
      <input type="text" id="username" placeholder="Enter Minecraft username" required />
      <button type="button" id="fetchBtn">Fetch Stats</button>
    </div>

    <div class="checkbox-group" style="margin-top:10px;">
      <label><input type="checkbox" id="milo" /> Milo</label>
      <label><input type="checkbox" id="potat" /> Potat</label>
      <label><input type="checkbox" id="aballs" /> Aballs</label>
      <label><input type="checkbox" id="zoiv" /> Zoiv</label>
      <label style="display:block; margin-top:20px; color:#ff4c4c; font-weight:700;">
        <input type="checkbox" id="cheating" /> Player was cheating
      </label>
    </div>

    <div id="status" role="alert" aria-live="assertive" style="text-align:center; margin-top:10px; color:#00c8ff; font-weight:600;">
    </div>
  </form>

  <div id="statsDisplay" aria-live="polite" role="region" aria-label="Player statistics">
    <div id="statsContent">
      <img id="statsAvatar" src="" alt="Player head" />
      <div id="statsRight">
        <div id="statsTopRow">
          <span id="statsRank"></span>
          <span id="statsUsername"></span>
          <span id="statsStar">★0</span>
        </div>
        <div id="statsColumns">
          <div class="stat-column good">
            <div class="stat-label">Wins:</div><div class="stat-value" id="statWins">0</div>
            <div class="stat-label">Finals:</div><div class="stat-value" id="statFinals">0</div>
            <div class="stat-label">Kills:</div><div class="stat-value" id="statKills">0</div>
            <div class="stat-label">Beds Broken:</div><div class="stat-value" id="statBeds">0</div>
          </div>
          <div class="stat-column bad">
            <div class="stat-label">Losses:</div><div class="stat-value" id="statLosses">0</div>
            <div class="stat-label">Final Deaths:</div><div class="stat-value" id="statFinalDeaths">0</div>
            <div class="stat-label">Deaths:</div><div class="stat-value" id="statDeaths">0</div>
            <div class="stat-label">Beds Lost:</div><div class="stat-value" id="statBedsLost">0</div>
          </div>
          <div class="stat-column neutral">
            <div class="stat-label">WLR:</div><div class="stat-value" id="statWLR">0</div>
            <div class="stat-label">FKDR:</div><div class="stat-value" id="statFKDR">0</div>
            <div class="stat-label">KDR:</div><div class="stat-value" id="statKDR">0</div>
            <div class="stat-label">BBLR:</div><div class="stat-value" id="statBBLR">0</div>
          </div>
          <div id="statsUrchin" class="stat-column neutral">
            <div class="stat-label">Urchin Tags:</div>
            <div class="stat-value" id="statUrchin">None</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div style="display:flex; justify-content:center; margin-top:15px;">
    <button type="submit" style="width:180px; padding:10px 0; font-size:16px;">Add Sweat</button>
  </div>
</div>

<h2 class="section-header">Defeated Sweats</h2>
<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Search username..." aria-label="Search sweat players" />
</div>

<!-- FILTER UI -->
<div class="filter-bar" aria-label="Minimum stat filters">
  <label for="minStars">Min Stars
    <input id="minStars" type="number" step="1" placeholder="e.g. 100" aria-label="Minimum Stars">
  </label>
  <label for="minFkdr">Min FKDR
    <input id="minFkdr" type="number" step="0.1" placeholder="e.g. 2.5" aria-label="Minimum FKDR">
  </label>
  <label for="minIndex">Min Index
    <input id="minIndex" type="number" step="1" placeholder="e.g. 300" aria-label="Minimum Index">
  </label>
  <label for="minDate">Min Date
    <input id="minDate" type="date" aria-label="Minimum Date">
  </label>

  <!-- NEW: Hide duplicates filter -->
  <label for="hideDuplicates">
    <input type="checkbox" id="hideDuplicates" />
    Hide dupes
  </label>

  <button id="resetFiltersBtn" type="button" aria-label="Reset filters">Reset</button>
</div>

<table>
  <thead>
    <tr>
      <th>Username</th>
      <th class="sortable" data-sort="star">Star ▲▼</th>
      <th class="sortable" data-sort="fkdr">FKDR ▲▼</th>
      <th class="sortable" data-sort="index">Index ▲▼</th>
      <th class="sortable" data-sort="cheating">Cheats ▲▼</th>
      <th class="sortable" data-sort="dateAdded">Date ▲▼</th>
      <th>Beaten By</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="sweatTable"></tbody>
</table>

</body>
</html>

<script>
const backendBaseURL = "https://bedwars-backend.onrender.com";

const form = document.getElementById('sweatForm');
const tableBody = document.getElementById('sweatTable');
const status = document.getElementById('status');
const fetchBtn = document.getElementById('fetchBtn');
const statsDisplay = document.getElementById('statsDisplay');
const searchInput = document.getElementById('searchInput');

const statsAvatar = document.getElementById('statsAvatar');
const statsUsername = document.getElementById('statsUsername');
const statsRank = document.getElementById('statsRank');
const statsStar = document.getElementById('statsStar');

const statWins = document.getElementById('statWins');
const statFinals = document.getElementById('statFinals');
const statKills = document.getElementById('statKills');
const statBeds = document.getElementById('statBeds');

const statLosses = document.getElementById('statLosses');
const statFinalDeaths = document.getElementById('statFinalDeaths');
const statDeaths = document.getElementById('statDeaths');
const statBedsLost = document.getElementById('statBedsLost');

const statWLR = document.getElementById('statWLR');
const statFKDR = document.getElementById('statFKDR');
const statKDR = document.getElementById('statKDR');
const statBBLR = document.getElementById('statBBLR');
const statUrchin = document.getElementById('statUrchin');

const filterFkdr = document.getElementById('minFkdr');
const filterIndex = document.getElementById('minIndex');
const filterStars = document.getElementById('minStars');
const filterDate = document.getElementById('minDate');
const hideDuplicatesCheckbox = document.getElementById('hideDuplicates');
const resetFiltersBtn = document.getElementById('resetFiltersBtn');

let sweats = [];
let sortField = null;
let sortAsc = true;
let currentUUID = null;
let currentStats = null;
let currentFilter = "";

// Load sweats
async function loadSweats() {
  try {
    const res = await fetch(`${backendBaseURL}/sweats?limit=1000`);
    if (!res.ok) throw new Error("Failed to fetch sweats");
    sweats = await res.json();
    renderTable();
  } catch (err) {
    status.textContent = "Error loading sweats: " + err.message;
  }
}

fetchBtn.addEventListener('click', async () => {
  await fetchAndDisplayStats();
});

function formatUrchinTagType(tagType) {
  switch(tagType) {
    case "confirmed_cheater": return "Confirmed Cheater";
    case "blatant_cheater": return "Blatant Cheater";
    case "closet_cheater": return "Closet Cheater";
    case "sniper": return "Sniper";
    default: return tagType; 
  }
}

form.addEventListener('submit', async e => {
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const milo = document.getElementById('milo').checked;
  const potat = document.getElementById('potat').checked;
  const aballs = document.getElementById('aballs').checked;
  const zoiv = document.getElementById('zoiv').checked;
  const cheating = document.getElementById('cheating').checked;

  if (!username) {
    alert("Please enter a username first.");
    return;
  }

  if (!milo && !potat && !aballs && !zoiv) {
    alert("Please select at least one player who beat them.");
    return;
  }

  status.textContent = "";
  statsDisplay.style.display = "none";

  try {
    if (!currentUUID || !currentStats || document.getElementById('username').value.trim().toLowerCase() !== currentStats.username.toLowerCase()) {
      await fetchAndDisplayStats();
    }

    const todayDate = new Date().toISOString();
    const newSweat = {
      username: currentStats.username,
      star: currentStats.star,
      fkdr: currentStats.fkdr,
      wlr: currentStats.wlr,
      bblr: currentStats.bblr,
      kdr: currentStats.kdr,
      finals: currentStats.finals,
      finalDeaths: currentStats.finalDeaths,
      beds: currentStats.beds,
      bedsLost: currentStats.bedsLost,
      kills: currentStats.kills,
      deaths: currentStats.deaths,
      milo,
      potat,
      aballs,
      zoiv,
      cheating,
      uuid: currentUUID,
      dateAdded: todayDate
    };

    const res = await fetch(`${backendBaseURL}/sweats`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newSweat)
    });
    if (!res.ok) throw new Error("Failed to add sweat");

    await loadSweats();
    form.reset();
    currentUUID = null;
    currentStats = null;
    statsDisplay.style.display = "none";
  } catch (err) {
    status.textContent = "Error: " + err.message;
  }
});

searchInput.addEventListener('input', () => {
  currentFilter = searchInput.value.trim().toLowerCase();
  renderTable();
});

resetFiltersBtn.addEventListener('click', () => {
  filterFkdr.value = "";
  filterIndex.value = "";
  filterStars.value = "";
  filterDate.value = "";
  renderTable();
});

[filterFkdr, filterIndex, filterStars, filterDate].forEach(inp => {
  inp.addEventListener('input', () => {
    renderTable();
  });
});

// Fetch Urchin tags from backend
async function fetchUrchinTags(username) {
  try {
    const res = await fetch(`${backendBaseURL}/urchin/${encodeURIComponent(username)}`);
    if (!res.ok) throw new Error("Urchin fetch failed");
    const data = await res.json();
    if (data.tags && data.tags.length > 0) {
      return data.tags.map(tag => formatUrchinTagType(tag.type)).join(", ");
    }
    return "None";
  } catch (err) {
    console.warn("Failed to fetch Urchin tags:", err);
    return "None";
  }
}

async function fetchAndDisplayStats() {
  const usernameInput = document.getElementById('username');
  const usernameRaw = usernameInput.value.trim();
  if (!usernameRaw) {
    alert("Please enter a username first.");
    throw new Error("Username missing");
  }

  status.textContent = "Fetching stats...";
  statsDisplay.style.display = "none";

  // Fetch UUID
  const resMojang = await fetch(`${backendBaseURL}/mojang/${usernameRaw}`);
  if (!resMojang.ok) throw new Error("Username not found");
  const mojangData = await resMojang.json();
  currentUUID = mojangData.id;
  usernameInput.value = mojangData.name;

  // Fetch player stats
  const data = await getPlayerStats(currentUUID);
  currentStats = {
    username: mojangData.name,
    star: calculateStarFromXP(data.exp),
    fkdr: data.fkdr,
    wlr: data.wlr,
    bblr: data.bblr,
    kdr: data.kdr,
    finals: data.finals,
    finalDeaths: data.finalDeaths,
    beds: data.beds,
    bedsLost: data.bedsLost,
    kills: data.kills,
    deaths: data.deaths,
    rank: getHypixelRank(data.player),
    wins: data.wins,
    losses: data.losses,
  };

  // Fetch Urchin tags
  const urTags = await fetchUrchinTags(currentStats.username);
  currentStats.urchinTags = urTags;

  updateStatsDisplay(currentStats);
  status.textContent = "";
}

async function getPlayerStats(uuid) {
  const res = await fetch(`${backendBaseURL}/player/${uuid}`);
  if (!res.ok) throw new Error("Player stats not found");
  const json = await res.json();
  const data = json.player.stats?.Bedwars || {};

  const exp = data.Experience || 0;
  const wins = data.wins_bedwars || 0;
  const losses = data.losses_bedwars || 0;
  const finalKills = data.final_kills_bedwars || 0;
  const finalDeaths = data.final_deaths_bedwars || 0;
  const bedsBroken = data.beds_broken_bedwars || 0;
  const bedsLost = data.beds_lost_bedwars || 0;
  const kills = data.kills_bedwars || 0;
  const deaths = data.deaths_bedwars || 0;

  return {
    exp,
    wlr: wins / (losses === 0 ? 1 : losses),
    fkdr: finalKills / (finalDeaths === 0 ? 1 : finalDeaths),
    kdr: kills / (deaths === 0 ? 1 : deaths),
    bblr: bedsLost === 0 ? bedsBroken : bedsBroken / bedsLost,
    finals: finalKills,
    finalDeaths,
    wins,
    losses,
    beds: bedsBroken,
    bedsLost,
    kills,
    deaths,
    player: json.player
  };
}

function calculateStarFromXP(exp) {
  if (exp < 0) return 0;
  let stars = 0;
  let xpLeft = exp;
  while (xpLeft >= 0) {
    let mod100 = stars % 100;
    let xpNeeded;
    if (mod100 === 0) xpNeeded = 500;
    else if (mod100 === 1) xpNeeded = 1000;
    else if (mod100 === 2) xpNeeded = 2000;
    else if (mod100 === 3 || mod100 === 4) xpNeeded = 3500;
    else xpNeeded = 5000;
    if (xpLeft < xpNeeded) break;
    xpLeft -= xpNeeded;
    stars++;
  }
  return stars;
}

function getHypixelRank(player) {
  if (!player) return {name:"[NONE]", color:"#AAA", prefix:""};
  const rank = player.rank || player.newPackageRank || player.packageRank || "NONE";
  switch(rank) {
    case "ADMIN": return {name:"ADMIN", color:"#FF5555", prefix:"[ADMIN] "};
    case "MODERATOR": return {name:"MOD", color:"#55FF55", prefix:"[MOD] "};
    case "MVP_PLUS": return {name:"MVP+", color:"#FFB74D", prefix:"[MVP+] "};
    case "MVP": return {name:"MVP", color:"#FFB74D", prefix:"[MVP] "};
    case "VIP_PLUS": return {name:"VIP+", color:"#FFB74D", prefix:"[VIP+] "};
    case "VIP": return {name:"VIP", color:"#FFB74D", prefix:"[VIP] "};
    default: return {name:"[NONE]", color:"#AAA", prefix:""};
  }
}

function updateStatsDisplay(stats) {
  statsAvatar.src = `https://crafatar.com/avatars/${currentUUID}?overlay`;
  statsUsername.textContent = stats.username;
  statsRank.textContent = stats.rank.prefix || "";
  statsRank.style.color = stats.rank.color;
  statsStar.textContent = `★${stats.star}`;

  statWins.textContent = stats.wins;
  statFinals.textContent = stats.finals;
  statKills.textContent = stats.kills;
  statBeds.textContent = stats.beds;

  statLosses.textContent = stats.losses;
  statFinalDeaths.textContent = stats.finalDeaths;
  statDeaths.textContent = stats.deaths;
  statBedsLost.textContent = stats.bedsLost;

  statWLR.textContent = stats.wlr.toFixed(2);
  statFKDR.textContent = stats.fkdr.toFixed(2);
  statKDR.textContent = stats.kdr.toFixed(2);
  statBBLR.textContent = stats.bblr.toFixed(2);

  statUrchin.textContent = stats.urchinTags || "None";

  statsDisplay.style.display = "flex";
}

	function renderTable() {
		// basic search filter
		let filteredSweats = sweats.filter(s => s.username.toLowerCase().includes(currentFilter));

		// read filter inputs (treat empty as no filter)
		const minFkdr = (filterFkdr && filterFkdr.value.trim() !== "") ? parseFloat(filterFkdr.value) : null;
		const minIndex = (filterIndex && filterIndex.value.trim() !== "") ? parseFloat(filterIndex.value) : null;
		const minStars = (filterStars && filterStars.value.trim() !== "") ? parseInt(filterStars.value) : null;
		const minDate = filterDate && filterDate.value ? new Date(filterDate.value + "T00:00:00") : null;

		// apply numeric filters if set
		if (minFkdr !== null || minIndex !== null || minStars !== null || minDate !== null) {
			filteredSweats = filteredSweats.filter(s => {
				const sFkdr = Number(s.fkdr) || 0;
				const sStar = Number(s.star) || 0;
				const sIndex = sFkdr * sFkdr * sStar;
				const sDate = new Date(s.dateAdded);

				if (minFkdr !== null && sFkdr < minFkdr) return false;
				if (minIndex !== null && sIndex < minIndex) return false;
				if (minStars !== null && sStar < minStars) return false;
				if (minDate !== null && sDate < minDate) return false;

				return true;
			});
		}

		// --- STEP 1: count occurrences BEFORE deduplication
		const usernameCounts = {};
		filteredSweats.forEach(s => {
			const uname = s.username.toLowerCase();
			usernameCounts[uname] = (usernameCounts[uname] || 0) + 1;
		});

		// --- STEP 2: remove duplicates if toggle is on
		if (hideDuplicatesCheckbox && hideDuplicatesCheckbox.checked) {
			const uniqueMap = new Map();
			filteredSweats.forEach(s => {
				const uname = s.username.toLowerCase();
				if (!uniqueMap.has(uname)) {
					uniqueMap.set(uname, s);
				}
			});
			filteredSweats = Array.from(uniqueMap.values());
		}

		// --- STEP 3: sorting
		if (sortField) {
			filteredSweats.sort((a, b) => {
				let valA, valB;

				if (sortField === "index") {
					valA = a.fkdr * a.fkdr * a.star;
					valB = b.fkdr * b.fkdr * b.star;
				} else if (sortField === "dateAdded") {
					valA = new Date(a.dateAdded);
					valB = new Date(b.dateAdded);
				} else if (sortField === "cheating") {
					valA = a.cheating ? 1 : 0;
					valB = b.cheating ? 1 : 0;
				} else {
					valA = a[sortField];
					valB = b[sortField];
				}

				if (valA < valB) return sortAsc ? -1 : 1;
				if (valA > valB) return sortAsc ? 1 : -1;
				return 0;
			});
		}

		// --- STEP 4: render table
		tableBody.innerHTML = "";

		filteredSweats.forEach(s => {
			const tr = document.createElement("tr");

			const usernameTd = document.createElement("td");
			usernameTd.classList.add('user-cell');

			const avatarImg = document.createElement("img");
			avatarImg.classList.add('user-avatar');
			avatarImg.src = `https://crafatar.com/avatars/${s.uuid}?overlay`;
			avatarImg.alt = `Avatar of ${s.username}`;

			const usernameText = document.createElement("span");
			let displayName = s.username;
			if (hideDuplicatesCheckbox.checked) {
				const count = usernameCounts[s.username.toLowerCase()];
				if (count > 1) {
					displayName += ` (x${count})`;
				}
			}
			usernameText.textContent = displayName;

			usernameTd.appendChild(avatarImg);
			usernameTd.appendChild(usernameText);
			tr.appendChild(usernameTd);

			const starTd = document.createElement("td");
			starTd.textContent = s.star;
			tr.appendChild(starTd);

			const fkdrTd = document.createElement("td");
			fkdrTd.textContent = s.fkdr.toFixed(2);
			tr.appendChild(fkdrTd);

			const indexValue = s.fkdr * s.fkdr * s.star;
			const indexTd = document.createElement("td");
			indexTd.textContent = Math.round(indexValue).toLocaleString();
			tr.appendChild(indexTd);

			const cheatingTd = document.createElement("td");
			cheatingTd.textContent = s.cheating ? "Yes" : "No";
			tr.appendChild(cheatingTd);

			const dateTd = document.createElement("td");
			dateTd.textContent = new Date(s.dateAdded).toLocaleDateString();
			tr.appendChild(dateTd);

			const beatenByTd = document.createElement("td");
			let beatenBy = [];
			if (s.milo) beatenBy.push("Milo");
			if (s.potat) beatenBy.push("Potat");
			if (s.aballs) beatenBy.push("Aballs");
			if (s.zoiv) beatenBy.push("Zoiv");
			beatenByTd.textContent = beatenBy.join(", ");
			tr.appendChild(beatenByTd);

			const removeTd = document.createElement("td");
			const removeBtn = document.createElement("button");
			removeBtn.textContent = "✖";
			removeBtn.addEventListener("click", () => removeSweat(s._id));
			removeTd.appendChild(removeBtn);
			tr.appendChild(removeTd);

			tableBody.appendChild(tr);
		});
	}

  async function removeSweat(id) {
    if (!confirm("Are you sure you want to remove this sweat?")) return;
    try {
      const res = await fetch(`${backendBaseURL}/sweats/${id}`, { method: "DELETE" });
      if (!res.ok) throw new Error("Failed to remove sweat");
      await loadSweats();
    } catch (err) {
      alert("Error removing sweat: " + err.message);
    }
  }

  document.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", () => {
      const field = th.dataset.sort;
      if (sortField === field) sortAsc = !sortAsc;
      else {
        sortField = field;
        sortAsc = true;
      }
      renderTable();
    });
  });


  if (hideDuplicatesCheckbox) {
    hideDuplicatesCheckbox.addEventListener('change', renderTable);
  }

  // Load all sweats on startup
  loadSweats();
</script>

</body>
</html>