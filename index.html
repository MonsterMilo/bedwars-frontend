<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bedwars Sweat Tracker</title>
<style>
  body {
    background: #121212;
    color: #ddd;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  #form-container {
    max-width: 820px;
    margin: 0 auto 10px;
    display: flex;
    gap: 20px;
    justify-content: center;
    align-items: flex-start;
  }
  form {
    background: #222;
    padding: 20px;
    border-radius: 8px;
    width: 420px;
    display: grid;
    gap: 14px;
    min-height: 230px;
  }
  input[type="text"] {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    background: #333;
    color: #eee;
  }
  button {
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    font-size: 15px;
    transition: background-color 0.3s ease;
  }
  button#fetchBtn {
    background: #444;
    color: #f0a500;
    max-width: 130px;
    margin-left: auto;
  }
  button#fetchBtn:hover {
    background: #666;
  }
  button[type="submit"] {
    background: #f0a500;
    color: #121212;
    width: 100%;
  }
  button[type="submit"]:hover {
    background: #d18a00;
  }
  table {
    width: 95%;
    max-width: 950px;
    margin: 10px auto 0;
    border-collapse: collapse;
    background: #222;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 8px rgba(240, 165, 0, 0.3);
    table-layout: fixed;
    word-wrap: break-word;
  }
  th, td {
    padding: 12px 16px;
    border-bottom: 1px solid #444;
    text-align: center;
    font-size: 15px;
    vertical-align: middle;
  }
  th {
    background: #333;
    color: #f0a500;
    user-select: none;
    cursor: pointer;
    white-space: nowrap;
  }
  th.sortable:hover {
    background: #444;
  }
  tr:hover {
    background: #2d2d2d;
  }
  button.remove-btn {
    background: none;
    border: none;
    color: #e03e3e;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }
  button.remove-btn:hover {
    color: #b92b2b;
  }
  #status {
    text-align: center;
    color: #f0a500;
    min-height: 20px;
    margin-top: -10px;
    margin-bottom: 6px;
  }
  .checkbox-group {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .checkbox-group label {
    font-weight: normal;
    color: #ccc;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  #statsDisplay {
    background: #222;
    border-radius: 8px;
    color: #f0a500;
    font-size: 15px;
    padding: 20px 24px;
    width: 580px;
    min-height: 230px;
    box-shadow: 0 0 10px #f0a500aa;
    display: none;
    user-select: none;
  }

  #statsContent {
    display: flex;
    gap: 20px;
  }

  #statsAvatar {
    flex-shrink: 0;
    width: 110px;
    height: 110px;
    border-radius: 14px;
    box-shadow: 0 0 10px #f0a500cc;
  }

  #statsRight {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  #statsTopRow {
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 22px;
    font-weight: 700;
    color: #f0a500;
    margin-bottom: 14px;
  }

  #statsRank {
    white-space: nowrap;
    font-weight: 700;
  }

  #statsUsername {
    color: #eee;
    font-weight: 900;
  }

  #statsStar {
    font-size: 24px;
    background: linear-gradient(45deg, #ffd700, #ffa500);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  #statsColumns {
    display: flex;
    gap: 24px;
    font-size: 14px;
    color: #ddd;
    user-select: none;
    flex-wrap: nowrap;
  }

  .stat-column {
    flex: 1;
    display: grid;
    grid-template-columns: auto auto;
    row-gap: 8px;
    column-gap: 12px;
  }

  .stat-column.good {
    color: #63d471;
  }

  .stat-column.bad {
    color: #e05959;
  }

  .stat-column.neutral {
    color: #f0a500;
  }

  .stat-label {
    font-weight: 700;
  }

  .stat-value {
    text-align: right;
    font-weight: 600;
  }

  /* Avatar in table */
  .avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    vertical-align: middle;
    margin-right: 8px;
    box-shadow: 0 0 4px #f0a500aa;
  }
  .username-cell {
    text-align: left;
    padding-left: 12px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    white-space: nowrap;
  }

  /* Ensure beaten by stays on one line */
  td:nth-child(5) {
    white-space: nowrap;
  }

  /* Search box styling */
  #searchContainer {
    width: 95%;
    max-width: 950px;
    margin: 0 auto 10px;
    text-align: right;
  }
  #searchInput {
    padding: 8px 14px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    background: #333;
    color: #eee;
    width: 250px;
  }
</style>
</head>
<body>

<h1>Bedwars Sweat Tracker</h1>

<div id="form-container">
  <form id="sweatForm" autocomplete="off">
    <div style="display:flex; gap:10px; align-items:center;">
      <input type="text" id="username" placeholder="Enter Minecraft username" required />
      <button type="button" id="fetchBtn">Fetch Stats</button>
    </div>

    <div class="checkbox-group" style="margin-top:10px;">
      <label><input type="checkbox" id="milo" /> Milo</label>
      <label><input type="checkbox" id="potat" /> Potat</label>
      <label><input type="checkbox" id="aballs" /> Aballs</label>
      <label><input type="checkbox" id="zoiv" /> Zoiv</label>
    </div>

    <button type="submit">Add Sweat</button>
    <div id="status"></div>
  </form>

  <div id="statsDisplay" aria-live="polite" role="region" aria-label="Player statistics">
    <div id="statsContent">
      <img id="statsAvatar" src="" alt="Player head" />
      <div id="statsRight">
        <div id="statsTopRow">
          <span id="statsRank"></span>
          <span id="statsUsername"></span>
          <span id="statsStar">★0</span>
        </div>
        <div id="statsColumns">
          <div class="stat-column good">
            <div class="stat-label">Wins:</div><div class="stat-value" id="statWins">0</div>
            <div class="stat-label">Finals:</div><div class="stat-value" id="statFinals">0</div>
            <div class="stat-label">Kills:</div><div class="stat-value" id="statKills">0</div>
            <div class="stat-label">Beds Broken:</div><div class="stat-value" id="statBeds">0</div>
          </div>
          <div class="stat-column bad">
            <div class="stat-label">Losses:</div><div class="stat-value" id="statLosses">0</div>
            <div class="stat-label">Final Deaths:</div><div class="stat-value" id="statFinalDeaths">0</div>
            <div class="stat-label">Deaths:</div><div class="stat-value" id="statDeaths">0</div>
            <div class="stat-label">Beds Lost:</div><div class="stat-value" id="statBedsLost">0</div>
          </div>
          <div class="stat-column neutral">
            <div class="stat-label">WLR:</div><div class="stat-value" id="statWLR">0</div>
            <div class="stat-label">FKDR:</div><div class="stat-value" id="statFKDR">0</div>
            <div class="stat-label">KDR:</div><div class="stat-value" id="statKDR">0</div>
            <div class="stat-label">BBLR:</div><div class="stat-value" id="statBBLR">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Search username..." aria-label="Search sweat players" />
</div>

<table>
  <thead>
    <tr>
      <th>Username</th>
      <th class="sortable" data-sort="star">Star ▲▼</th>
      <th class="sortable" data-sort="fkdr">FKDR ▲▼</th>
      <th class="sortable" data-sort="wlr">WLR ▲▼</th>
      <th>Beaten By</th>
      <th class="sortable" data-sort="dateAdded">Date Added ▲▼</th>
      <th>Remove</th>
    </tr>
  </thead>
  <tbody id="sweatTable"></tbody>
</table>

<script>
  const form = document.getElementById('sweatForm');
  const tableBody = document.getElementById('sweatTable');
  const status = document.getElementById('status');
  const fetchBtn = document.getElementById('fetchBtn');
  const statsDisplay = document.getElementById('statsDisplay');
  const searchInput = document.getElementById('searchInput');

  const statsAvatar = document.getElementById('statsAvatar');
  const statsUsername = document.getElementById('statsUsername');
  const statsRank = document.getElementById('statsRank');
  const statsStar = document.getElementById('statsStar');

  const statWins = document.getElementById('statWins');
  const statFinals = document.getElementById('statFinals');
  const statKills = document.getElementById('statKills');
  const statBeds = document.getElementById('statBeds');

  const statLosses = document.getElementById('statLosses');
  const statFinalDeaths = document.getElementById('statFinalDeaths');
  const statDeaths = document.getElementById('statDeaths');
  const statBedsLost = document.getElementById('statBedsLost');

  const statWLR = document.getElementById('statWLR');
  const statFKDR = document.getElementById('statFKDR');
  const statKDR = document.getElementById('statKDR');
  const statBBLR = document.getElementById('statBBLR');

  let sweats = [];
  let sortField = null;
  let sortAsc = true;
  let currentUUID = null;
  let currentStats = null;
  let currentFilter = "";

  // Fetch sweat list from backend on load
  async function fetchSweats() {
    try {
      const res = await fetch('https://bedwars-backend.onrender.com/sweats');
      if (!res.ok) throw new Error('Failed to fetch sweats');
      sweats = await res.json();
      renderTable();
    } catch (e) {
      status.textContent = 'Error loading sweat list.';
      console.error(e);
    }
  }

  // Render table rows
  function renderTable() {
    let filtered = sweats.filter(s => s.username.toLowerCase().includes(currentFilter));
    if (sortField) {
      filtered.sort((a,b) => {
        if(sortField === 'dateAdded') {
          return sortAsc ? new Date(a.dateAdded) - new Date(b.dateAdded) : new Date(b.dateAdded) - new Date(a.dateAdded);
        }
        if (typeof a[sortField] === 'number' && typeof b[sortField] === 'number') {
          return sortAsc ? a[sortField] - b[sortField] : b[sortField] - a[sortField];
        }
        if (typeof a[sortField] === 'string' && typeof b[sortField] === 'string') {
          return sortAsc ? a[sortField].localeCompare(b[sortField]) : b[sortField].localeCompare(a[sortField]);
        }
        return 0;
      });
    }

    tableBody.innerHTML = filtered.map(s => `
      <tr>
        <td class="username-cell">
          <img class="avatar-small" src="https://crafatar.com/avatars/${s.uuid}?size=32&overlay" alt="${s.username} avatar" />
          ${s.username}
        </td>
        <td>${s.star}</td>
        <td>${s.fkdr.toFixed(2)}</td>
        <td>${s.wlr.toFixed(2)}</td>
        <td>${s.beatenBy.join(', ') || '-'}</td>
        <td>${new Date(s.dateAdded).toLocaleDateString()}</td>
        <td><button class="remove-btn" aria-label="Remove ${s.username} from sweats" data-uuid="${s.uuid}">&times;</button></td>
      </tr>
    `).join('');
  }

  // Sorting handler
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      if (sortField === th.dataset.sort) {
        sortAsc = !sortAsc;
      } else {
        sortField = th.dataset.sort;
        sortAsc = true;
      }
      renderTable();
    });
  });

  // Remove sweat handler
  tableBody.addEventListener('click', async e => {
    if(e.target.classList.contains('remove-btn')) {
      const uuid = e.target.dataset.uuid;
      if(confirm('Remove this sweat from your list?')) {
        try {
          const res = await fetch(`https://bedwars-backend.onrender.com/sweats/${uuid}`, { method: 'DELETE' });
          if(!res.ok) throw new Error('Failed to delete sweat');
          sweats = sweats.filter(s => s.uuid !== uuid);
          renderTable();
          status.textContent = `Removed sweat successfully.`;
        } catch (err) {
          status.textContent = 'Error removing sweat.';
        }
      }
    }
  });

  // Search input handler
  searchInput.addEventListener('input', e => {
    currentFilter = e.target.value.trim().toLowerCase();
    renderTable();
  });

  // Fetch stats from API and show in statsDisplay
  async function fetchStats(username) {
    if (!username) return;

    status.textContent = 'Loading stats...';
    statsDisplay.style.display = 'none';

    try {
      const res = await fetch(`https://bedwars-backend.onrender.com/stats/${username}`);
      if (!res.ok) throw new Error('Player not found');
      const data = await res.json();

      currentUUID = data.uuid;
      currentStats = data;

      statsAvatar.src = `https://crafatar.com/avatars/${data.uuid}?size=110&overlay`;
      statsUsername.textContent = data.username;
      statsRank.textContent = data.rank || '';
      statsStar.textContent = `★${data.star}`;
      
      statWins.textContent = data.wins;
      statFinals.textContent = data.finals;
      statKills.textContent = data.kills;
      statBeds.textContent = data.bedsBroken;

      statLosses.textContent = data.losses;
      statFinalDeaths.textContent = data.finalDeaths;
      statDeaths.textContent = data.deaths;
      statBedsLost.textContent = data.bedsLost;

      statWLR.textContent = data.wlr.toFixed(2);
      statFKDR.textContent = data.fkdr.toFixed(2);
      statKDR.textContent = data.kdr.toFixed(2);
      statBBLR.textContent = data.bblr.toFixed(2);

      statsDisplay.style.display = 'block';
      status.textContent = '';

    } catch (err) {
      status.textContent = 'Player not found or error fetching stats.';
      statsDisplay.style.display = 'none';
      currentUUID = null;
      currentStats = null;
    }
  }

  // Fetch button click handler
  fetchBtn.addEventListener('click', async () => {
    const username = document.getElementById('username').value.trim();
    if (!username) {
      status.textContent = 'Please enter a username to fetch stats.';
      return;
    }
    await fetchStats(username);
  });

  // Form submission handler to add sweat
  form.addEventListener('submit', async e => {
    e.preventDefault();

    if (!currentUUID || !currentStats) {
      status.textContent = 'Fetch a valid player first before adding.';
      return;
    }

    const usernameInput = document.getElementById('username').value.trim();
    if (!usernameInput || usernameInput.toLowerCase() !== currentStats.username.toLowerCase()) {
      status.textContent = 'Username input does not match fetched player.';
      return;
    }

    // Collect beaten by checked boxes
    const beatenBy = [];
    if(document.getElementById('milo').checked) beatenBy.push('Milo');
    if(document.getElementById('potat').checked) beatenBy.push('Potat');
    if(document.getElementById('aballs').checked) beatenBy.push('Aballs');
    if(document.getElementById('zoiv').checked) beatenBy.push('Zoiv');

    // Build payload
    const payload = {
      uuid: currentUUID,
      username: currentStats.username,
      beatenBy,
      star: currentStats.star,
      fkdr: currentStats.fkdr,
      wlr: currentStats.wlr,
      dateAdded: new Date().toISOString()
    };

    status.textContent = 'Adding sweat...';

    try {
      const res = await fetch('https://bedwars-backend.onrender.com/sweats', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Failed to add sweat');

      const newSweat = await res.json();
      sweats.push(newSweat);
      renderTable();
      status.textContent = `Added sweat for ${newSweat.username}!`;

      // Reset checkboxes
      ['milo', 'potat', 'aballs', 'zoiv'].forEach(id => {
        document.getElementById(id).checked = false;
      });

    } catch (err) {
      status.textContent = 'Error adding sweat.';
    }
  });

  // Initial load
  fetchSweats();
</script>

</body>
</html>
